<!DOCTYPE html>
<html>

<head>
  <title>Jraph Form</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <link rel="stylesheet" href="static/style.css">
  <script src="static/togeojson.js"></script>
  <script src="static/leaflet.filelayer.js"></script>
  <!-- <meta http-equiv="refresh" content="3"> -->
</head>

<body>

  <header>
    <h1> Jraph KML Creation Tool </h1>
  </header>

  <main>
    <div>

      <div id="control-panel">

        <form action="/" method="POST" id="query-form">
          <label for="search">Search</label>
          <input type="text" name="search" id="search">
          <button type="submit">Submit</button>
        </form>

      </div>

      <div>
        <h3>Output</h3>
        <a href="/download">Download KML</a>
        <a href="/download-gpkg">Download GPKG</a>

        <h4>Kml Preview</h4>
        <pre id="kml-display"></pre>

        <h3>Previous Queries</h3>
        <ol id="prev">
        </ol>
        <br>
      </div>
    </div>

    <div id="map"></div>

    <script>

      const map = L.map('map').setView([43.206879, -71.538162], 13);

      const tiles = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      }).addTo(map);

      const control = L.Control.fileLayerLoad({
        layer: L.geoJson,
        layerOptions: {style: {color: 'red'}},
        addToMap: true,
        fileSizeLimit: 1024,
        formats: [
          '.geojson',
          '.kml',
        ]
      }).addTo(map);

      control.loader.on('data:error', function (error) {
        console.log('ERROR', error);
      });
      // === NEW: Auto-load KML after form submission ===
      let currentLayer = null; // To remove previous results

      document.getElementById('query-form').addEventListener('submit', async function (e) {
        e.preventDefault(); // Prevent full page reload

        const formData = new FormData(this);

        try {
          // Step 1: Submit query to Flask backend
          const response = await fetch('/', {
            method: 'POST',
            body: formData
          });

          if (!response.ok) throw new Error('Query failed');

          respJson = await response.json()
          kmlText = respJson.kml
          document.getElementById('kml-display').textContent = kmlText
          prevEntry = document.createElement('li')
          prevEntry.textContent = respJson.previousQuery
          document.getElementById('prev').appendChild(prevEntry)

          // Step 2: Parse KML to GeoJSON using togeojson
          const kmlDoc = new DOMParser().parseFromString(kmlText, 'text/xml');
          const geojson = toGeoJSON.kml(kmlDoc);

          // Step 3: Remove previous layer
          if (currentLayer) {
            map.removeLayer(currentLayer);
          }

          // Step 4: Add new GeoJSON layer
          currentLayer = L.geoJSON(geojson, {
            style: {color: 'blue', weight: 4},
            onEachFeature: function (feature, layer) {
              if (feature.properties && feature.properties.name) {
                layer.bindPopup(feature.properties.name);
              }
            }
          }).addTo(map);

          // Step 5: Fit map to bounds
          if (geojson.features.length > 0) {
            map.fitBounds(currentLayer.getBounds());
          } else {
            alert('No features found for this query.');
          }

        } catch (err) {
          console.error(err);
          alert('Error: ' + err.message);
        }
      });

    </script>

  </main>

</body>

</html>
